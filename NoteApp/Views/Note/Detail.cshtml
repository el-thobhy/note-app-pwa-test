@model NoteApp.Models.Note
@inject NoteApp.Services.IDailyEntryService _entryService
@{
    DateTime selectedDate = ViewBag.SelectedDate;
    var entry = ViewBag.Entry as NoteApp.Models.DailyEntry;
    ViewData["Title"] = "Detail";
}

<div class="mb-4">
    <a href="/" class="btn btn-outline-secondary rounded-pill shadow-sm mb-3">
        <i class="bi bi-arrow-left-circle me-1"></i> Kembali
    </a>
    <div class="d-flex justify-content-between">
        <h2 class="fw-semibold text-dark">
            <i class="bi bi-journal-text me-2 text-primary"></i> @Model.Title
        </h2>
        <div>
            <button class="btn btn-outline-primary btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#addEntryModal">
                <i class="bi bi-calendar-plus me-1"></i> Tambah Entry Baru
            </button>
        </div>
    </div>
    <p class="text-muted"><i class="bi bi-calendar-event me-1"></i> @selectedDate.ToString("dd MMMM yyyy")</p>
</div>

<div class="modal fade" id="addEntryModal" tabindex="-1" aria-labelledby="addEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="manualAddEntryForm" action="/Note/AddEntry">
            @Html.AntiForgeryToken()
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Tanggal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="NoteId" value="@Model.Id" />
                    <label for="newEntryDate" class="form-label">Tanggal</label>
                    <input type="date" name="Date" class="form-control" id="newEntryDate" required />
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Buat Entry</button>
                </div>
            </div>
        </form>
    </div>
</div>


<div class="card rounded-4 shadow-sm">
    <div class="card-body">
        <form method="post" id="entryForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="NoteId" value="@Model.Id" />
            <input type="hidden" name="Date" id="dateNote" value="@selectedDate" />
            @if (entry != null)
            {
                <input type="hidden" name="Id" value="@entry.Id" />
            }

            <input placeholder="Title" class="form-control mb-2" type="text" name="Title_Note" value="@entry?.Title_Note" />
            <textarea id="ContentEditor" name="Content">@entry?.Content</textarea>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary rounded-pill" id="submitBtn">
                    <i class="bi bi-save me-1"></i> Simpan Catatan
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        tinymce.init({
            selector: '#ContentEditor',
            menubar: false,
            height: 300,
            plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount autosave code fullscreen',
            toolbar: 'code fullscreen | myPageBreakButton | undo redo | blocks fontsize | bold italic forecolor removeformat | link image table | alignleft aligncenter alignright lineheight | numlist bullist indent outdent ',
            branding: false
        });

        $("#entryForm").submit(function (e) {
            e.preventDefault();

            const $btn = $("#submitBtn");
            const originalHtml = $btn.html();
            $btn.prop("disabled", true).html(`<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Menyimpan...`);

            const token = $('input[name="__RequestVerificationToken"]').val();
            const content = tinymce.get("ContentEditor").getContent();

            const isEdit = $("input[name='Id']").length > 0;
            const url = isEdit ? "/Note/UpdateEntry" : "/Note/AddEntry";

            $.ajax({
                type: "POST",
                url: url,
                data: {
                    __RequestVerificationToken: token,
                    Id: $("input[name='Id']").val(),
                    NoteId: $("input[name='NoteId']").val(),
                    Date: $("#dateNote").val(),
                    Title_Note: $("input[name='Title_Note']").val(),
                    Content: content
                },
                success: function () {
                    location.reload();
                },
                error: function () {
                    $btn.prop("disabled", false).html(originalHtml);
                    alert("Terjadi kesalahan saat menyimpan.");
                }
            });
        });
        $("#manualAddEntryForm").submit(function (e) {
            e.preventDefault();

            const token = $('input[name="__RequestVerificationToken"]').val();
            const noteId = $(this).find("input[name='NoteId']").val();
            const date = $(this).find("input[name='Date']").val();

            const $btn = $(this).find("button[type='submit']");
            const originalHtml = $btn.html();
            $btn.prop("disabled", true).html(`<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Membuat...`);

            $.ajax({
                type: "POST",
                url: "/Note/AddEntry",
                data: {
                    __RequestVerificationToken: token,
                    NoteId: noteId,
                    Date: date,
                    Content: "" // kosongkan, nanti bisa diedit di halaman detail
                },
                success: function () {
                    // Setelah berhasil insert, redirect ke halaman detail dengan tanggal tersebut
                    window.location.href = `/Note/Detail?id=${noteId}&date=${date}`;
                },
                error: function () {
                    $btn.prop("disabled", false).html(originalHtml);
                    alert("Gagal membuat entry.");
                }
            });
        });


    </script>
}
